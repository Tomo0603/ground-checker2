name: ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç©ºãç›£è¦–

on:
  schedule:
    - cron: '0 * * * *'  # 1æ™‚é–“ã”ã¨
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  check-availability:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # ã‚¸ãƒ§ãƒ–å…¨ä½“ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆèŒ…ãƒ¶å´ãŒé‡ã„ãŸã‚å»¶é•·ï¼‰

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm install

      - run: npx playwright install chromium --with-deps

      - uses: actions/cache@v4
        with:
          path: state.json
          key: notification-state-${{ github.run_id }}
          restore-keys: notification-state-

      - id: check
        run: node check-github.js
        env:
          CHUGAI_LOGIN_ID: ${{ secrets.CHUGAI_LOGIN_ID }}
          CHUGAI_PASSWORD: ${{ secrets.CHUGAI_PASSWORD }}
        continue-on-error: true

      - if: steps.check.outputs.new_availability == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const result = JSON.parse(fs.readFileSync('result.json', 'utf8'));

            let body = 'æ–°ã—ã„ç©ºãæ ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼\n\n';

            result.forEach(item => {
              if (item.newSlots && item.newSlots.length > 0) {
                body += `## ğŸ‰ ${item.name}\n\n`;
                item.newSlots.forEach(slot => {
                  body += `- ${slot}\n`;
                });
                body += '\n';
              }
            });

            body += `\n---\næ¤œå‡ºæ™‚åˆ»: ${new Date().toLocaleString('ja-JP', {timeZone: 'Asia/Tokyo'})}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ‰ ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç©ºãç™ºè¦‹ï¼ (${new Date().toLocaleDateString('ja-JP', {timeZone: 'Asia/Tokyo'})})`,
              body: body,
              labels: ['ç©ºãé€šçŸ¥']
            });

      - uses: actions/cache/save@v4
        if: always()
        with:
          path: state.json
          key: notification-state-${{ github.run_id }}

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: check-logs-${{ github.run_number }}
          path: |
            *.log
            *.json
          retention-days: 7
