name: ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç©ºãç›£è¦–

on:
  schedule:
    - cron: '0 * * * *'  # 1æ™‚é–“ã”ã¨
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  check-availability:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - run: npm install
      - run: npx playwright install chromium --with-deps
      
      - uses: actions/cache@v4
        with:
          path: state.json
          key: notification-state-${{ github.run_id }}
          restore-keys: notification-state-
      
      - id: check
        run: node check-github.js
        continue-on-error: true
      
      - if: steps.check.outputs.new_availability == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const result = JSON.parse(fs.readFileSync('result.json', 'utf8'));
            
            let body = 'æ–°ã—ã„ç©ºãæ ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼\n\n';
            
            result.forEach(item => {
              if (item.newSlots && item.newSlots.length > 0) {
                body += `## ğŸ‰ ${item.name}\n\n`;
                item.newSlots.forEach(slot => {
                  body += `- ${slot}\n`;
                });
                body += '\n';
              }
            });
            
            body += `\n---\næ¤œå‡ºæ™‚åˆ»: ${new Date().toLocaleString('ja-JP', {timeZone: 'Asia/Tokyo'})}`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ‰ ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç©ºãç™ºè¦‹ï¼ (${new Date().toLocaleDateString('ja-JP')})`,
              body: body,
              labels: ['ç©ºãé€šçŸ¥']
            });
      
      - uses: actions/cache/save@v4
        if: always()
        with:
          path: state.json
          key: notification-state-${{ github.run_id }}
